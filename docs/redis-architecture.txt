AgentAPI Redis Architecture
============================

Deployment Option 1: Production with Upstash Redis
---------------------------------------------------

┌─────────────────────────────────────────────────────────────────┐
│                        Docker Host                               │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              AgentAPI Container                         │    │
│  │                                                          │    │
│  │  ┌────────────────────────────────────────────────┐   │    │
│  │  │  Go Backend (Port 3284)                        │   │    │
│  │  │  • REST API Endpoints                           │   │    │
│  │  │  • Authentication & Authorization               │   │    │
│  │  │  • Multi-tenant Management                      │   │    │
│  │  └──────────────┬─────────────────────────────────┘   │    │
│  │                 │                                       │    │
│  │  ┌──────────────▼─────────────────────────────────┐   │    │
│  │  │  Python FastMCP (Port 8000)                    │   │    │
│  │  │  • MCP Server Management                        │   │    │
│  │  │  • Tool Integration                             │   │    │
│  │  └──────────────┬─────────────────────────────────┘   │    │
│  │                 │                                       │    │
│  │  ┌──────────────▼─────────────────────────────────┐   │    │
│  │  │  Redis Client Library                          │   │    │
│  │  │  • Connection Management                        │   │    │
│  │  │  • Session Handler                              │   │    │
│  │  │  • Rate Limiter                                 │   │    │
│  │  │  • Circuit Breaker                              │   │    │
│  │  │  • Cache Manager                                │   │    │
│  │  └──────────────┬─────────────────────────────────┘   │    │
│  └─────────────────┼──────────────────────────────────────┘    │
│                    │                                            │
│  ┌─────────────────▼──────────────────────────────────────┐    │
│  │         PostgreSQL Container (Port 5432)              │    │
│  │         • User Data                                    │    │
│  │         • Tenant Configuration                         │    │
│  │         • Persistent Storage                           │    │
│  └────────────────────────────────────────────────────────┘    │
└──────────────────────┼───────────────────────────────────────────┘
                       │
                       │ HTTPS (TLS)
                       │ rediss://
                       ▼
          ┌─────────────────────────┐
          │                         │
          │   Upstash Redis Cloud   │
          │                         │
          │  • Serverless Redis     │
          │  • Auto-scaling         │
          │  • High Availability    │
          │  • Global Replication   │
          │  • Automatic Backups    │
          │  • REST API + Native    │
          │                         │
          └─────────────────────────┘


Deployment Option 2: Development with Local Redis
--------------------------------------------------

┌─────────────────────────────────────────────────────────────────┐
│                        Docker Host                               │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              AgentAPI Container                         │    │
│  │                                                          │    │
│  │  ┌────────────────────────────────────────────────┐   │    │
│  │  │  Go Backend (Port 3284)                        │   │    │
│  │  └──────────────┬─────────────────────────────────┘   │    │
│  │                 │                                       │    │
│  │  ┌──────────────▼─────────────────────────────────┐   │    │
│  │  │  Python FastMCP (Port 8000)                    │   │    │
│  │  └──────────────┬─────────────────────────────────┘   │    │
│  │                 │                                       │    │
│  │  ┌──────────────▼─────────────────────────────────┐   │    │
│  │  │  Redis Client Library                          │   │    │
│  │  └──────────────┬─────────────────────────────────┘   │    │
│  └─────────────────┼──────────────────────────────────────┘    │
│                    │                                            │
│                    │ redis://                                   │
│                    │ (Docker Network)                           │
│                    ▼                                            │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │         Redis Container (Port 6379)                      │  │
│  │         • redis:7-alpine                                 │  │
│  │         • AOF Persistence                                │  │
│  │         • RDB Snapshots                                  │  │
│  │         • LRU Eviction                                   │  │
│  │         • 256MB Memory                                   │  │
│  │                                                           │  │
│  │  Volume: ./data/redis ◄──────────────────────────┐      │  │
│  └──────────────▲───────────────────────────────────┼──────┘  │
│                 │                                    │         │
│                 │                                    │         │
│  ┌──────────────┴───────────────────────────────────┼──────┐  │
│  │      Redis Insights Container (Port 8001)        │      │  │
│  │      • Web GUI                                    │      │  │
│  │      • Key Browser                                │      │  │
│  │      • Performance Monitor                        │      │  │
│  │                                                    │      │  │
│  │  Volume: ./data/redis-insights ◄──────────────────┘      │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │         PostgreSQL Container (Port 5432)                 │  │
│  │         Volume: ./data/postgres                          │  │
│  └─────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘


Redis Data Flow
---------------

Session Management:
──────────────────
Client Request
    ↓
[AgentAPI] → Validate Token
    ↓
[Redis] → GET session:{token}
    ↓
Session Found? ──Yes→ Extend TTL → Continue Request
    │
    └──No→ Return 401 Unauthorized


Rate Limiting:
─────────────
Client Request
    ↓
[AgentAPI] → Extract User/IP
    ↓
[Redis] → INCR ratelimit:{id}:{window}
    ↓
Counter > Limit? ──Yes→ Return 429 Too Many Requests
    │
    └──No→ Continue Request


Circuit Breaker:
───────────────
Service Call Request
    ↓
[AgentAPI] → Check Circuit State
    ↓
[Redis] → GET circuit:{service}:state
    ↓
State = OPEN? ──Yes→ Fast Fail
    │
    └──No→ Attempt Call
        ↓
    Success? ──Yes→ INCR success counter
        │          Check threshold → Close circuit
        │
        └──No→ INCR failure counter
               Check threshold → Open circuit


Cache Flow:
──────────
Data Request
    ↓
[AgentAPI] → Check Cache
    ↓
[Redis] → GET cache:{key}
    ↓
Cache Hit? ──Yes→ Return Cached Data
    │
    └──No→ Fetch from Database
           → Store in Redis (with TTL)
           → Return Fresh Data


Service Dependencies
───────────────────

AgentAPI depends on:
├── PostgreSQL (required)
│   └── Health Check: pg_isready
│
└── Redis (optional, when using local)
    └── Health Check: redis-cli ping

Redis Insights depends on:
└── Redis (required)
    └── Health Check: redis-cli ping


Environment Variable Flow
─────────────────────────

.env file
    ↓
    ├─→ UPSTASH_REDIS_REST_URL ────┐
    ├─→ UPSTASH_REDIS_REST_TOKEN ──┤
    ├─→ UPSTASH_REDIS_URL ─────────┤
    │                               ├──→ [Production Mode]
    ├─→ REDIS_ENABLE ──────────────┤    Connect to Upstash
    ├─→ REDIS_PROTOCOL ────────────┘
    │
    ├─→ REDIS_URL ─────────────────┐
    ├─→ REDIS_MAX_POOL_SIZE ───────┤
    ├─→ REDIS_CONNECTION_TIMEOUT ──┤
    │                               ├──→ [Development Mode]
    ├─→ RATE_LIMIT_ENABLED ────────┤    Connect to Local Redis
    ├─→ CIRCUIT_BREAKER_ENABLED ───┤
    ├─→ SESSION_STORAGE ───────────┤
    ├─→ SESSION_TTL ───────────────┤
    └─→ TOKEN_ENCRYPTION_KEY ──────┘


Network Architecture
───────────────────

Docker Network: agentapi-network (172.20.0.0/16)
    │
    ├─→ agentapi (container)
    │   └── Exposes: 3284 (API), 8000 (MCP)
    │
    ├─→ postgres (container)
    │   └── Exposes: 5432 (internal only)
    │
    ├─→ redis (container, optional)
    │   └── Exposes: 6379 (internal only)
    │
    └─→ redis-insights (container, optional)
        └── Exposes: 8001 (external)


Volume Structure
───────────────

./data/
├── workspaces/          (AgentAPI workspace data)
├── postgres/            (PostgreSQL data)
├── redis/              (Redis persistence)
│   ├── appendonly.aof  (AOF file)
│   └── dump.rdb        (RDB snapshot)
└── redis-insights/     (RedisInsight config)


Health Check Flow
────────────────

Docker Compose Start
    ↓
PostgreSQL starts
    ↓
    [Health Check: pg_isready]
    ↓
    ├─→ Healthy ──→ Continue
    └─→ Unhealthy → Retry (5 times, 10s interval)
        ↓
        └─→ Still Unhealthy → Fail
    ↓
Redis starts (if local)
    ↓
    [Health Check: redis-cli ping]
    ↓
    ├─→ Healthy ──→ Continue
    └─→ Unhealthy → Retry (5 times, 10s interval)
        ↓
        └─→ Still Unhealthy → Fail
    ↓
AgentAPI starts (depends_on satisfied)
    ↓
    [Health Check: wget http://localhost:3284/status]
    ↓
    ├─→ Healthy ──→ Service Ready
    └─→ Unhealthy → Retry (3 times, 30s interval)
        ↓
        └─→ Still Unhealthy → Mark Unhealthy


Resource Allocation
──────────────────

╔════════════════════╦═══════╦════════╦════════════════╗
║ Service            ║  CPU  ║ Memory ║ Disk           ║
╠════════════════════╬═══════╬════════╬════════════════╣
║ AgentAPI           ║ 1-2   ║ 2-4 GB ║ Minimal        ║
║ PostgreSQL         ║ 0.5-1 ║ 512MB  ║ ./data/postgres║
║                    ║       ║ -2GB   ║                ║
║ Redis (local)      ║ 0.25  ║ 256-   ║ ./data/redis   ║
║                    ║ -0.5  ║ 512MB  ║                ║
║ Redis Insights     ║ 0.1   ║ 128-   ║ ./data/redis-  ║
║ (optional)         ║ -0.25 ║ 256MB  ║ insights       ║
╚════════════════════╩═══════╩════════╩════════════════╝

Total (without Redis Insights): 1.75-3.5 CPU, 2.75-6.5 GB RAM
Total (with Redis Insights):    1.85-3.75 CPU, 2.88-6.75 GB RAM
