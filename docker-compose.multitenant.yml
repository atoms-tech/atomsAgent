version: '3.8'

services:
  # ============================================================================
  # AgentAPI Service - Multi-tenant application with Go backend and Python MCP
  # ============================================================================
  agentapi:
    build:
      context: .
      dockerfile: Dockerfile.multitenant
    container_name: agentapi
    ports:
      - "3284:3284"  # Go AgentAPI server
      - "8000:8000"  # Python FastMCP service
    environment:
      # Database Configuration
      - DATABASE_URL=${DATABASE_URL:-postgresql://agentapi:agentapi@postgres:5432/agentapi?sslmode=disable}

      # Supabase Configuration
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}

      # AI Provider API Keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - VERTEX_AI_API_KEY=${VERTEX_AI_API_KEY}
      - VERTEX_AI_PROJECT_ID=${VERTEX_AI_PROJECT_ID:-}
      - VERTEX_AI_LOCATION=${VERTEX_AI_LOCATION:-us-central1}

      # Google Cloud Platform
      - GCP_PROJECT_ID=${GCP_PROJECT_ID:-}
      - GCP_SECRET_MANAGER_KEY=${GCP_SECRET_MANAGER_KEY:-}

      # OAuth Configuration
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID:-}
      - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET:-}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID:-common}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID:-}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET:-}
      - AUTH0_DOMAIN=${AUTH0_DOMAIN:-}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE:-}

      # Application Configuration
      - NODE_ENV=${NODE_ENV:-production}
      - AGENTAPI_PORT=3284
      - AGENTAPI_ALLOWED_HOSTS=${AGENTAPI_ALLOWED_HOSTS:-*}
      - AGENTAPI_ALLOWED_ORIGINS=${AGENTAPI_ALLOWED_ORIGINS:-*}

      # FastMCP Service Configuration
      - FASTMCP_PORT=8000
      - FASTMCP_HOST=0.0.0.0

      # Redis Configuration (optional)
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}

      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}

    volumes:
      # Persistent workspace data for user sessions
      - workspace_data:/workspaces

      # Mount database directory for migrations and schema
      - ./database:/app/database:ro

      # Optional: Mount for local development
      # - ./lib:/app/lib:ro
      # - ./.env:/app/.env:ro

    networks:
      - agentapi-network

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    restart: unless-stopped

    # Resource Limits and Reservations
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

    # Health Check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3284/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Logging Configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,component"
        env: "NODE_ENV"

    labels:
      - "com.agentapi.service=core"
      - "com.agentapi.environment=${NODE_ENV:-production}"
      - "com.agentapi.version=1.0.0"

  # ============================================================================
  # PostgreSQL Database - Local development database (optional)
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: agentapi-postgres
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-agentapi}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-agentapi}
      - POSTGRES_DB=${POSTGRES_DB:-agentapi}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8
      - PGDATA=/var/lib/postgresql/data/pgdata

    volumes:
      # Persistent database storage
      - postgres_data:/var/lib/postgresql/data

      # Optional: Initialize database with schema
      # - ./database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      # - ./database/migrations:/docker-entrypoint-initdb.d/migrations:ro

    networks:
      - agentapi-network

    restart: unless-stopped

    # Resource Limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Health Check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-agentapi} -d ${POSTGRES_DB:-agentapi}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Logging Configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    labels:
      - "com.agentapi.service=database"
      - "com.agentapi.environment=${NODE_ENV:-production}"

    # Security: Run as non-root user
    user: postgres

  # ============================================================================
  # Redis Cache - For session storage and caching (optional)
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: agentapi-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"

    command: >
      redis-server
      --appendonly yes
      --appendfilename "appendonly.aof"
      --dir /data
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory ${REDIS_MAX_MEMORY:-256mb}
      --maxmemory-policy allkeys-lru
      --loglevel ${REDIS_LOG_LEVEL:-notice}

    volumes:
      # Persistent cache storage
      - redis_data:/data

    networks:
      - agentapi-network

    restart: unless-stopped

    # Resource Limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    # Health Check
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

    # Logging Configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    labels:
      - "com.agentapi.service=cache"
      - "com.agentapi.environment=${NODE_ENV:-production}"

  # ============================================================================
  # Nginx Reverse Proxy - Optional for production-like setup
  # ============================================================================
  # Uncomment this section if you need a reverse proxy for SSL termination
  # nginx:
  #   image: nginx:alpine
  #   container_name: agentapi-nginx
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./nginx/conf.d:/etc/nginx/conf.d:ro
  #     - ./nginx/ssl:/etc/nginx/ssl:ro
  #     - nginx_logs:/var/log/nginx
  #   networks:
  #     - agentapi-network
  #   depends_on:
  #     agentapi:
  #       condition: service_healthy
  #   restart: unless-stopped
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.5'
  #         memory: 512M
  #       reservations:
  #         cpus: '0.25'
  #         memory: 128M
  #   healthcheck:
  #     test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   logging:
  #     driver: json-file
  #     options:
  #       max-size: "10m"
  #       max-file: "3"
  #   labels:
  #     - "com.agentapi.service=proxy"
  #     - "com.agentapi.environment=${NODE_ENV:-production}"

# ==============================================================================
# Named Volumes - Persistent data storage
# ==============================================================================
volumes:
  # User workspace data - stores user sessions and workspace files
  workspace_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${WORKSPACE_DATA_PATH:-./data/workspaces}
    labels:
      - "com.agentapi.volume=workspaces"
      - "com.agentapi.backup=true"

  # PostgreSQL database data
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${POSTGRES_DATA_PATH:-./data/postgres}
    labels:
      - "com.agentapi.volume=database"
      - "com.agentapi.backup=true"

  # Redis cache data
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${REDIS_DATA_PATH:-./data/redis}
    labels:
      - "com.agentapi.volume=cache"
      - "com.agentapi.backup=false"

  # Nginx logs (if using nginx)
  # nginx_logs:
  #   driver: local
  #   driver_opts:
  #     type: none
  #     o: bind
  #     device: ${NGINX_LOGS_PATH:-./logs/nginx}

# ==============================================================================
# Networks - Service networking
# ==============================================================================
networks:
  agentapi-network:
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET:-172.20.0.0/16}
    labels:
      - "com.agentapi.network=main"
      - "com.agentapi.environment=${NODE_ENV:-production}"
